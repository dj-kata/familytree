<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜åº¦ãªã‚³ã‚¢ãƒ©å®¶ç³»å›³ãƒ„ãƒ¼ãƒ«ï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆãƒ»ã‚¢ã‚¤ã‚³ãƒ³å¯¾å¿œï¼‰</title>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #e8f5e9 0%, #f0f8ff 100%);
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            padding: 25px;
        }

        .header {
            text-align: center;
            margin-bottom: 35px;
            padding: 20px;
            background: linear-gradient(135deg, #2e7d32, #4caf50);
            border-radius: 12px;
            color: white;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            margin: 10px 0 0 0;
            font-size: 1.2em;
            opacity: 0.9;
        }

        .input-section {
            background: linear-gradient(135deg, #e8f5e9, #f1f8e9);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid #4caf50;
        }

        .data-info {
            background: #fff3e0;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border-left: 5px solid #ff9800;
        }

        .csv-format {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border: 1px solid #ddd;
            overflow-x: auto;
        }

        .feature-highlight {
            background: #e3f2fd;
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            border-left: 5px solid #2196f3;
        }

        textarea {
            width: 100%;
            height: 250px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border: 3px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            resize: vertical;
            line-height: 1.4;
        }

        textarea:focus {
            border-color: #4caf50;
            outline: none;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }

        .button-group {
            margin: 20px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        button {
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2e7d32, #4caf50);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1b5e20, #388e3c);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #388e3c, #689f38);
            transform: translateY(-2px);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff9800, #ffc107);
            color: white;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #f57c00, #ffb300);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336, #e57373);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #d32f2f, #f44336);
            transform: translateY(-2px);
        }

        button:disabled {
            background: #cccccc !important;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .controls-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            display: none;
            border: 2px solid #dee2e6;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .control-group label {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }

        .control-group input,
        .control-group select {
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .control-group input:focus,
        .control-group select:focus {
            border-color: #4caf50;
            outline: none;
        }

        .range-control {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .range-control input[type="range"] {
            flex: 1;
            max-width: 150px;
        }

        .range-value {
            background: #4caf50;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            min-width: 50px;
            text-align: center;
        }

        .legend {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 2px solid #2196f3;
        }

        .legend h4 {
            margin: 0 0 15px 0;
            color: #1976d2;
            font-size: 18px;
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            background: white;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .legend-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 10px;
            border: 3px solid #333;
            flex-shrink: 0;
        }

        .legend-circle.male {
            background: #42a5f5;
            border-color: #1976d2;
        }

        .legend-circle.female {
            background: #ec407a;
            border-color: #c2185b;
        }

        .legend-circle.unknown {
            background: #bdbdbd;
            border-color: #757575;
        }

        .legend-diamond {
            width: 20px;
            height: 20px;
            background: #ff9800;
            border: 3px solid #f57c00;
            margin-right: 10px;
            transform: rotate(45deg);
            flex-shrink: 0;
        }

        #network-container {
            border: 3px solid #4caf50;
            border-radius: 12px;
            background: white;
            margin-top: 30px;
            height: 700px;
            position: relative;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);
        }

        .stats-info {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border: 2px solid #4caf50;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            font-weight: bold;
            color: #2e7d32;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
        }

        .error-message {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            border: 2px solid #f44336;
            color: #c62828;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            font-weight: bold;
        }

        .success-message {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border: 2px solid #4caf50;
            color: #2e7d32;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            font-weight: bold;
        }

        .highlight-controls {
            background: #fff3e0;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 2px solid #ff9800;
        }

        .highlight-controls h4 {
            margin: 0 0 10px 0;
            color: #f57c00;
        }

        .highlight-status {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
            color: #1976d2;
        }

        /* æ–°ã—ã„ã‚¹ã‚¿ã‚¤ãƒ«ï¼šãƒã‚¤ãƒ©ã‚¤ãƒˆåŠ¹æœ */
        .highlighted-node {
            filter: brightness(1.3) drop-shadow(0 0 10px #ffeb3b);
        }

        .highlighted-edge {
            filter: brightness(1.5) drop-shadow(0 0 5px #ffeb3b);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¨ é«˜åº¦ãªã‚³ã‚¢ãƒ©å®¶ç³»å›³ãƒ„ãƒ¼ãƒ«</h1>
            <p>ãƒã‚¤ãƒ©ã‚¤ãƒˆæ©Ÿèƒ½ãƒ»ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤ºãƒ»å¤«å©¦çµåˆç‚¹å¯¾å¿œ</p>
        </div>

        <div class="input-section">
            <h3>ğŸ“ ã‚³ã‚¢ãƒ©ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ï¼ˆã‚¢ã‚¤ã‚³ãƒ³å¯¾å¿œï¼‰</h3>
            <div class="data-info">
                <strong>æ–°æ©Ÿèƒ½æ­è¼‰:</strong> è¦ªå­ãƒã‚¤ãƒ©ã‚¤ãƒˆãƒ»å€‹ä½“ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤ºãƒ»å¤«å©¦çµåˆç‚¹ã‚·ã‚¹ãƒ†ãƒ 
                <div class="csv-format">
                    å€‹ä½“å,æ€§åˆ¥,ç”Ÿå¹´æœˆæ—¥,çˆ¶è¦ª,æ¯è¦ª,ã‚¢ã‚¤ã‚³ãƒ³<br>
                    ãƒãƒƒã‚¯ã‚¹,ã‚ªã‚¹,2015-03-20,,,https://example.com/koala_male.png<br>
                    ãƒ«ãƒŠ,ãƒ¡ã‚¹,2016-05-15,,,https://example.com/koala_female.png<br>
                    ã‚³ã‚¿ãƒ­ã‚¦,ã‚ªã‚¹,2020-06-12,ãƒãƒƒã‚¯ã‚¹,ãƒ«ãƒŠ,https://example.com/baby_koala.png
                </div>
                <div class="feature-highlight">
                    <strong>ğŸ”¥ æ–°æ©Ÿèƒ½:</strong>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>è¦ªå­ãƒã‚¤ãƒ©ã‚¤ãƒˆ:</strong> å­ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è¦ªã‚‚ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤º</li>
                        <li><strong>ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤º:</strong> ç”»åƒURLã‚’æŒ‡å®šã—ã¦å€‹ä½“ã®å†™çœŸã‚’è¡¨ç¤º</li>
                        <li><strong>çµåˆç‚¹ã‚·ã‚¹ãƒ†ãƒ :</strong> å¤«å©¦ã‚’çµåˆç‚¹ã§ç¹‹ãã€ãã“ã‹ã‚‰å­ã©ã‚‚ã¸ç·šã‚’å¼•ã</li>
                    </ul>
                </div>
            </div>
            
            <textarea id="csvInput" placeholder="CSVãƒ‡ãƒ¼ã‚¿ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„...&#10;&#10;ä¾‹ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ä»˜ãï¼‰:&#10;å€‹ä½“å,æ€§åˆ¥,ç”Ÿå¹´æœˆæ—¥,çˆ¶è¦ª,æ¯è¦ª,ã‚¢ã‚¤ã‚³ãƒ³&#10;ãƒãƒƒã‚¯ã‚¹,ã‚ªã‚¹,2015-03-20,,,https://example.com/icons/koala1.png&#10;ãƒ«ãƒŠ,ãƒ¡ã‚¹,2016-05-15,,,https://example.com/icons/koala2.png&#10;ã‚³ã‚¿ãƒ­ã‚¦,ã‚ªã‚¹,2020-06-12,ãƒãƒƒã‚¯ã‚¹,ãƒ«ãƒŠ,https://example.com/icons/baby.png"></textarea>
            
            <div class="button-group">
                <button class="btn-primary" onclick="generateKoalaNetwork()">ğŸŒ³ å®¶ç³»å›³ã‚’ç”Ÿæˆ</button>
                <button class="btn-secondary" onclick="loadSampleData()">ğŸ“ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€</button>
                <button class="btn-warning" onclick="exportNetwork()" id="exportBtn" disabled>ğŸ“¸ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ä¿å­˜</button>
                <button class="btn-danger" onclick="clearAll()">ğŸ—‘ï¸ ã™ã¹ã¦ã‚¯ãƒªã‚¢</button>
            </div>
        </div>

        <div class="controls-section" id="controlsSection">
            <h3>ğŸ›ï¸ è¡¨ç¤ºè¨­å®š</h3>
            <div class="controls-grid">
                <div class="control-group">
                    <label>ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</label>
                    <select id="layoutType" onchange="updateLayout()">
                        <option value="hierarchical" selected>éšå±¤è¡¨ç¤ºï¼ˆæ¨å¥¨ï¼‰</option>
                        <option value="force">åŠ›å­¦çš„é…ç½®</option>
                        <option value="circular">å††å½¢é…ç½®</option>
                        <option value="random">ãƒ©ãƒ³ãƒ€ãƒ é…ç½®</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>ãƒãƒ¼ãƒ‰ã‚µã‚¤ã‚º</label>
                    <div class="range-control">
                        <input type="range" id="nodeSize" min="30" max="100" value="50" oninput="updateNodeSize()">
                        <span id="nodeSizeValue" class="range-value">50</span>
                    </div>
                </div>
                
                <div class="control-group">
                    <label>ã‚¨ãƒƒã‚¸ã®å¤ªã•</label>
                    <div class="range-control">
                        <input type="range" id="edgeWidth" min="1" max="10" value="4" oninput="updateEdgeWidth()">
                        <span id="edgeWidthValue" class="range-value">4</span>
                    </div>
                </div>
                
                <div class="control-group">
                    <label>ç‰©ç†æ¼”ç®—</label>
                    <select id="physics" onchange="updatePhysics()">
                        <option value="true">æœ‰åŠ¹</option>
                        <option value="false">ç„¡åŠ¹</option>
                    </select>
                </div>

                <div class="control-group">
                    <button class="btn-secondary" onclick="fitNetwork()">ğŸ” å…¨ä½“ã‚’è¡¨ç¤º</button>
                </div>

                <div class="control-group">
                    <button class="btn-secondary" onclick="focusOnMales()">â™‚ ã‚ªã‚¹ã«æ³¨ç›®</button>
                </div>
            </div>

            <div class="highlight-controls">
                <h4>ğŸ”¦ ãƒã‚¤ãƒ©ã‚¤ãƒˆæ©Ÿèƒ½</h4>
                <p>å€‹ä½“ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€è¦ªå­é–¢ä¿‚ãŒãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã¾ã™</p>
                <div class="highlight-status" id="highlightStatus">
                    ãƒã‚¤ãƒ©ã‚¤ãƒˆ: ãªã—
                </div>
                <button class="btn-warning" onclick="clearHighlight()">ğŸ”„ ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ã‚¯ãƒªã‚¢</button>
            </div>

            <div class="legend">
                <h4>ğŸ·ï¸ å‡¡ä¾‹</h4>
                <div class="legend-grid">
                    <div class="legend-item">
                        <div class="legend-circle male"></div>
                        <span>ã‚ªã‚¹ï¼ˆç¹æ®–å€‹ä½“ï¼‰</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-circle female"></div>
                        <span>ãƒ¡ã‚¹ï¼ˆç¹æ®–å€‹ä½“ï¼‰</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-circle unknown"></div>
                        <span>æœªæˆç†Ÿãƒ»æ€§åˆ¥ä¸æ˜</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-diamond"></div>
                        <span>å¤«å©¦çµåˆç‚¹</span>
                    </div>
                    <div class="legend-item">
                        <div style="width: 30px; height: 4px; background: #4caf50; margin-right: 10px;"></div>
                        <span>å¤«å©¦é–¢ä¿‚</span>
                    </div>
                    <div class="legend-item">
                        <div style="width: 30px; height: 3px; background: #ff9800; margin-right: 10px; position: relative;">
                            <div style="position: absolute; right: -3px; top: -2px; width: 0; height: 0; border-left: 6px solid #ff9800; border-top: 3px solid transparent; border-bottom: 3px solid transparent;"></div>
                        </div>
                        <span>è¦ªå­é–¢ä¿‚</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="messages"></div>
        <div class="stats-info" id="statsInfo" style="display:none;"></div>
        <div id="network-container"></div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let koalaData = [];
        let network = null;
        let nodes, edges;
        let highlightedNodes = [];
        let highlightedEdges = [];
        let originalNodeColors = new Map();
        let originalEdgeColors = new Map();

        // åˆæœŸåŒ–
        function initialize() {
            updateDisplayValues();
            checkLibrariesLoaded();
        }

        // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ç¢ºèª
        function checkLibrariesLoaded() {
            const statusDiv = document.getElementById('library-status');
            if (statusDiv) statusDiv.remove();

            const status = document.createElement('div');
            status.id = 'library-status';
            status.style.cssText = 'background: #e3f2fd; padding: 15px; margin: 15px 0; border-radius: 8px; font-size: 14px; border: 2px solid #2196f3;';
            
            const checks = [];
            checks.push(typeof vis !== 'undefined' ? 'âœ… vis.js' : 'âŒ vis.js');
            checks.push(typeof Papa !== 'undefined' ? 'âœ… PapaParse' : 'âŒ PapaParse');
            
            status.innerHTML = `ğŸ“š ãƒ©ã‚¤ãƒ–ãƒ©ãƒªçŠ¶æ³: ${checks.join(' | ')}`;
            
            if (typeof vis === 'undefined') {
                status.innerHTML += '<br>âš ï¸ vis.jsã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚';
                status.style.background = '#ffebee';
                status.style.borderColor = '#f44336';
            }
            
            document.querySelector('.header').appendChild(status);
        }

        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadSampleData() {
            const sampleCSV = `å€‹ä½“å,æ€§åˆ¥,ç”Ÿå¹´æœˆæ—¥,çˆ¶è¦ª,æ¯è¦ª,ã‚¢ã‚¤ã‚³ãƒ³
ãƒãƒƒã‚¯ã‚¹,ã‚ªã‚¹,2015-03-20,,,https://dj-kata.github.io/koala_familytree/imgs/fuku.png
ãƒ€ã‚¤ã‚­,ã‚ªã‚¹,2014-08-15,,,https://cdn.pixabay.com/photo/2016/10/31/18/14/koala-1786089_960_720.png
ãƒ«ãƒŠ,ãƒ¡ã‚¹,2016-05-15,,,https://cdn.pixabay.com/photo/2017/01/20/15/06/koala-1995961_960_720.png
ã‚µã‚¯ãƒ©,ãƒ¡ã‚¹,2017-08-10,,,https://cdn.pixabay.com/photo/2017/01/20/15/06/koala-1995961_960_720.png
ãƒãƒŠ,ãƒ¡ã‚¹,2018-02-28,,,https://cdn.pixabay.com/photo/2017/01/20/15/06/koala-1995961_960_720.png
ãƒŸã‚¯,ãƒ¡ã‚¹,2015-12-03,,,https://cdn.pixabay.com/photo/2017/01/20/15/06/koala-1995961_960_720.png
ãƒ¦ãƒª,ãƒ¡ã‚¹,2016-09-22,,,https://cdn.pixabay.com/photo/2017/01/20/15/06/koala-1995961_960_720.png
ã‚³ã‚¿ãƒ­ã‚¦,ã‚ªã‚¹,2020-06-12,ãƒãƒƒã‚¯ã‚¹,ãƒ«ãƒŠ,https://cdn.pixabay.com/photo/2018/09/22/17/05/koala-3695359_960_720.png
ãƒãƒ«ã‚«,ãƒ¡ã‚¹,2020-08-25,ãƒãƒƒã‚¯ã‚¹,ã‚µã‚¯ãƒ©,https://cdn.pixabay.com/photo/2018/09/22/17/05/koala-3695359_960_720.png
ã‚¿ãƒ­ã‚¦,ã‚ªã‚¹,2021-03-18,ãƒãƒƒã‚¯ã‚¹,ãƒãƒŠ,https://cdn.pixabay.com/photo/2018/09/22/17/05/koala-3695359_960_720.png
ã‚¸ãƒ­ã‚¦,ã‚ªã‚¹,2021-07-30,ãƒ€ã‚¤ã‚­,ãƒŸã‚¯,https://cdn.pixabay.com/photo/2018/09/22/17/05/koala-3695359_960_720.png
ã‚µãƒ©,ãƒ¡ã‚¹,2021-11-14,ãƒ€ã‚¤ã‚­,ãƒ¦ãƒª,https://cdn.pixabay.com/photo/2018/09/22/17/05/koala-3695359_960_720.png
ãƒãƒ“å¤ª,ã‚ªã‚¹,2022-04-08,ãƒãƒƒã‚¯ã‚¹,ãƒ«ãƒŠ,https://cdn.pixabay.com/photo/2019/01/30/12/19/koala-3965326_960_720.png
ã‚³ã‚³,ãƒ¡ã‚¹,2022-09-19,ãƒãƒƒã‚¯ã‚¹,ã‚µã‚¯ãƒ©,https://cdn.pixabay.com/photo/2019/01/30/12/19/koala-3965326_960_720.png
ãƒ”ãƒ¼ãƒ,ãƒ¡ã‚¹,2023-01-25,ãƒ€ã‚¤ã‚­,ãƒŸã‚¯,https://cdn.pixabay.com/photo/2019/01/30/12/19/koala-3965326_960_720.png`;
            
            document.getElementById('csvInput').value = sampleCSV;
            showMessage('ã‚¢ã‚¤ã‚³ãƒ³ä»˜ãã‚³ã‚¢ãƒ©ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ï¼ˆè¦ªå­ãƒã‚¤ãƒ©ã‚¤ãƒˆæ©Ÿèƒ½ãƒ»ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤ºå¯¾å¿œï¼‰', 'success');
        }

        // CSVãƒ‡ãƒ¼ã‚¿è§£æ
        function parseKoalaData(csvText) {
            return new Promise((resolve, reject) => {
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        try {
                            if (results.errors.length > 0) {
                                reject(new Error('CSVè§£æã‚¨ãƒ©ãƒ¼: ' + results.errors[0].message));
                                return;
                            }

                            const koalas = results.data.map((row, index) => {
                                const name = (row['å€‹ä½“å'] || row['åå‰'] || '').trim();
                                const gender = (row['æ€§åˆ¥'] || '').trim();
                                const birthDate = (row['ç”Ÿå¹´æœˆæ—¥'] || '').trim();
                                const father = (row['çˆ¶è¦ª'] || '').trim();
                                const mother = (row['æ¯è¦ª'] || '').trim();
                                const icon = (row['ã‚¢ã‚¤ã‚³ãƒ³'] || row['icon'] || '').trim();

                                if (!name) {
                                    throw new Error(`${index + 2}è¡Œç›®: å€‹ä½“åãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“`);
                                }

                                return {
                                    name,
                                    gender,
                                    birthDate,
                                    father,
                                    mother,
                                    icon,
                                    partners: [] // å¾Œã§è‡ªå‹•è¨ˆç®—
                                };
                            });

                            // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼é–¢ä¿‚ã‚’è‡ªå‹•æ¨å®š
                            inferPartnerRelationships(koalas);

                            resolve(koalas);
                        } catch (error) {
                            reject(error);
                        }
                    },
                    error: function(error) {
                        reject(new Error('CSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message));
                    }
                });
            });
        }

        // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼é–¢ä¿‚ã‚’è‡ªå‹•æ¨å®š
        function inferPartnerRelationships(koalas) {
            const partnerPairs = new Map();

            koalas.forEach(koala => {
                if (koala.father && koala.mother) {
                    const pairKey = [koala.father, koala.mother].sort().join('|');
                    if (!partnerPairs.has(pairKey)) {
                        partnerPairs.set(pairKey, []);
                    }
                    partnerPairs.get(pairKey).push(koala.name);
                }
            });

            partnerPairs.forEach((children, pairKey) => {
                const [parent1, parent2] = pairKey.split('|');
                
                const koala1 = koalas.find(k => k.name === parent1);
                const koala2 = koalas.find(k => k.name === parent2);
                
                if (koala1 && koala2) {
                    if (!koala1.partners.includes(parent2)) {
                        koala1.partners.push(parent2);
                    }
                    if (!koala2.partners.includes(parent1)) {
                        koala2.partners.push(parent1);
                    }
                }
            });

            console.log('æ¨å®šã•ã‚ŒãŸãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼é–¢ä¿‚:', partnerPairs);
        }

        // ã‚³ã‚¢ãƒ©ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç”Ÿæˆ
        async function generateKoalaNetwork() {
            clearMessages();
            
            if (typeof vis === 'undefined') {
                showMessage('ã‚¨ãƒ©ãƒ¼: vis.jsãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }
            
            try {
                const csvText = document.getElementById('csvInput').value.trim();
                if (!csvText) {
                    throw new Error('CSVãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                }

                koalaData = await parseKoalaData(csvText);
                
                if (koalaData.length === 0) {
                    throw new Error('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }

                createNetworkData();
                drawNetwork();

                // UIæ›´æ–°
                document.getElementById('controlsSection').style.display = 'block';
                document.getElementById('exportBtn').disabled = false;

                // çµ±è¨ˆæƒ…å ±è¡¨ç¤º
                const stats = calculateKoalaStats(koalaData);
                document.getElementById('statsInfo').innerHTML = 
                    `ğŸ“Š ã‚³ã‚¢ãƒ©çµ±è¨ˆ: ç·å€‹ä½“æ•° ${stats.total}åŒ¹ã€ã‚ªã‚¹ ${stats.males}åŒ¹ã€ãƒ¡ã‚¹ ${stats.females}åŒ¹ã€ç¹æ®–ãƒšã‚¢ ${stats.breedingPairs}çµ„ã€ä¸–ä»£æ•° ${stats.generations}ä¸–ä»£<br>ğŸ–¼ï¸ ã‚¢ã‚¤ã‚³ãƒ³ä»˜ãå€‹ä½“: ${stats.withIcons}åŒ¹`;
                document.getElementById('statsInfo').style.display = 'block';

                showMessage(`ã‚³ã‚¢ãƒ©å®¶ç³»å›³ã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼ï¼ˆ${stats.total}åŒ¹ã€ãƒã‚¤ãƒ©ã‚¤ãƒˆæ©Ÿèƒ½ãƒ»ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤ºå¯¾å¿œï¼‰`, 'success');

            } catch (error) {
                showMessage('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿ä½œæˆ
        function createNetworkData() {
            const nodeArray = [];
            const edgeArray = [];
            const nodeIds = new Set();
            const edgeIds = new Set();

            // å€‹ä½“ãƒãƒ¼ãƒ‰ä½œæˆ
            koalaData.forEach(koala => {
                if (!nodeIds.has(koala.name)) {
                    const nodeConfig = {
                        id: koala.name,
                        label: koala.name,
                        group: getKoalaGroup(koala),
                        title: createTooltip(koala),
                        data: koala,
                        size: parseInt(document.getElementById('nodeSize').value),
                        font: { size: 14, color: '#333' },
                        borderWidth: 3
                    };

                    // ã‚¢ã‚¤ã‚³ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ç”»åƒãƒãƒ¼ãƒ‰ã«
                    if (koala.icon && koala.icon.startsWith('http')) {
                        nodeConfig.shape = 'circularImage';
                        nodeConfig.image = koala.icon;
                        nodeConfig.borderWidth = 4;
                        nodeConfig.borderWidthSelected = 6;
                    } else {
                        nodeConfig.shape = 'dot';
                    }

                    nodeArray.push(nodeConfig);
                    nodeIds.add(koala.name);
                }
            });

            // å¤«å©¦ãƒšã‚¢ã‚’ç‰¹å®šã—ã€çµåˆãƒãƒ¼ãƒ‰ã‚’ä½œæˆ
            const coupleMap = new Map();
            const unionNodes = new Map();

            koalaData.forEach(koala => {
                if (koala.father && koala.mother) {
                    const coupleKey = [koala.father, koala.mother].sort().join('|');
                    if (!coupleMap.has(coupleKey)) {
                        coupleMap.set(coupleKey, []);
                    }
                    coupleMap.get(coupleKey).push(koala.name);
                }
            });

            // å¤«å©¦ãƒšã‚¢ã”ã¨ã«çµåˆãƒãƒ¼ãƒ‰ã‚’ä½œæˆ
            coupleMap.forEach((children, coupleKey) => {
                const [parent1, parent2] = coupleKey.split('|');
                const unionNodeId = `union_${coupleKey}`;
                
                // çµåˆãƒãƒ¼ãƒ‰ä½œæˆ
                nodeArray.push({
                    id: unionNodeId,
                    label: '',
                    group: 'union',
                    title: `${parent1} ã¨ ${parent2} ã®çµåˆç‚¹<br>å­ã©ã‚‚: ${children.join(', ')}`,
                    shape: 'diamond',
                    size: 20,
                    color: {
                        background: '#ff9800',
                        border: '#f57c00'
                    },
                    font: { size: 10 },
                    borderWidth: 3
                });
                
                unionNodes.set(coupleKey, unionNodeId);
                nodeIds.add(unionNodeId);

                // å¤«å©¦ã‚’çµåˆãƒãƒ¼ãƒ‰ã«æ¥ç¶š
                const edgeId1 = `marriage_${parent1}_${unionNodeId}`;
                if (!edgeIds.has(edgeId1)) {
                    edgeArray.push({
                        id: edgeId1,
                        from: parent1,
                        to: unionNodeId,
                        color: { color: '#4caf50' },
                        width: parseInt(document.getElementById('edgeWidth').value),
                        dashes: false,
                        arrows: { to: { enabled: false } },
                        smooth: false,
                        type: 'marriage'
                    });
                    edgeIds.add(edgeId1);
                }

                const edgeId2 = `marriage_${parent2}_${unionNodeId}`;
                if (!edgeIds.has(edgeId2)) {
                    edgeArray.push({
                        id: edgeId2,
                        from: parent2,
                        to: unionNodeId,
                        color: { color: '#4caf50' },
                        width: parseInt(document.getElementById('edgeWidth').value),
                        dashes: false,
                        arrows: { to: { enabled: false } },
                        smooth: false,
                        type: 'marriage'
                    });
                    edgeIds.add(edgeId2);
                }

                // çµåˆãƒãƒ¼ãƒ‰ã‹ã‚‰å­ã©ã‚‚ã¸ã®æ¥ç¶š
                children.forEach(child => {
                    const childEdgeId = `offspring_${unionNodeId}_${child}`;
                    if (!edgeIds.has(childEdgeId)) {
                        edgeArray.push({
                            id: childEdgeId,
                            from: unionNodeId,
                            to: child,
                            color: { color: '#ff9800' },
                            width: parseInt(document.getElementById('edgeWidth').value) - 1,
                            arrows: { to: { enabled: true, scaleFactor: 1.2 } },
                            dashes: false,
                            smooth: { type: 'continuous', roundness: 0.3 },
                            type: 'offspring'
                        });
                        edgeIds.add(childEdgeId);
                    }
                });
            });

            nodes = new vis.DataSet(nodeArray);
            edges = new vis.DataSet(edgeArray);

            // å…ƒã®è‰²ã‚’ä¿å­˜
            originalNodeColors.clear();
            originalEdgeColors.clear();
            nodeArray.forEach(node => {
                originalNodeColors.set(node.id, node.color || getDefaultNodeColor(node.group));
            });
            edgeArray.forEach(edge => {
                originalEdgeColors.set(edge.id, edge.color);
            });
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ¼ãƒ‰è‰²å–å¾—
        function getDefaultNodeColor(group) {
            switch (group) {
                case 'male':
                    return { background: '#42a5f5', border: '#1976d2' };
                case 'female':
                    return { background: '#ec407a', border: '#c2185b' };
                case 'union':
                    return { background: '#ff9800', border: '#f57c00' };
                default:
                    return { background: '#bdbdbd', border: '#757575' };
            }
        }

        // ã‚³ã‚¢ãƒ©ã‚°ãƒ«ãƒ¼ãƒ—åˆ¤å®š
        function getKoalaGroup(koala) {
            if (koala.gender === 'ã‚ªã‚¹' || koala.gender === 'â™‚' || koala.gender.toLowerCase() === 'male') {
                return 'male';
            } else if (koala.gender === 'ãƒ¡ã‚¹' || koala.gender === 'â™€' || koala.gender.toLowerCase() === 'female') {
                return 'female';
            } else {
                return 'unknown';
            }
        }

        // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ä½œæˆ
        function createTooltip(koala) {
            let tooltip = `<strong>${koala.name}</strong><br>`;
            tooltip += `æ€§åˆ¥: ${koala.gender}<br>`;
            
            if (koala.birthDate) {
                const age = calculateAge(koala.birthDate);
                tooltip += `ç”Ÿå¹´æœˆæ—¥: ${koala.birthDate} (${age}æ­³)<br>`;
            }
            
            if (koala.father || koala.mother) {
                tooltip += `ä¸¡è¦ª: `;
                if (koala.father) tooltip += `çˆ¶ ${koala.father} `;
                if (koala.mother) tooltip += `æ¯ ${koala.mother}`;
                tooltip += `<br>`;
            }
            
            if (koala.partners.length > 0) {
                tooltip += `ç¹æ®–ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼: ${koala.partners.join(', ')}<br>`;
            }

            const childrenCount = koalaData.filter(k => 
                k.father === koala.name || k.mother === koala.name
            ).length;
            
            if (childrenCount > 0) {
                tooltip += `å­ã©ã‚‚ã®æ•°: ${childrenCount}åŒ¹<br>`;
            }

            if (koala.icon) {
                tooltip += `ã‚¢ã‚¤ã‚³ãƒ³: æœ‰ã‚Š<br>`;
            }
            
            return tooltip;
        }

        // å¹´é½¢è¨ˆç®—
        function calculateAge(birthDate) {
            const birth = new Date(birthDate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            return age;
        }

        // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æç”»
        function drawNetwork() {
            if (typeof vis === 'undefined') {
                showMessage('ã‚¨ãƒ©ãƒ¼: vis.jsãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'error');
                return;
            }

            const container = document.getElementById('network-container');
            const data = { nodes: nodes, edges: edges };
            
            const options = {
                nodes: {
                    font: {
                        size: 14,
                        color: '#333'
                    },
                    shadow: {
                        enabled: true,
                        color: 'rgba(0,0,0,0.2)',
                        size: 5
                    }
                },
                edges: {
                    font: {
                        size: 12,
                        color: '#666'
                    },
                    smooth: {
                        type: 'continuous'
                    },
                    shadow: {
                        enabled: true,
                        color: 'rgba(0,0,0,0.1)',
                        size: 3
                    }
                },
                groups: {
                    male: {
                        color: {
                            background: '#42a5f5',
                            border: '#1976d2'
                        }
                    },
                    female: {
                        color: {
                            background: '#ec407a',
                            border: '#c2185b'
                        }
                    },
                    unknown: {
                        color: {
                            background: '#bdbdbd',
                            border: '#757575'
                        }
                    },
                    union: {
                        color: {
                            background: '#ff9800',
                            border: '#f57c00'
                        },
                        shape: 'diamond'
                    }
                },
                layout: getLayoutOptions(),
                physics: {
                    enabled: document.getElementById('physics').value === 'true',
                    stabilization: { iterations: 200 }
                },
                interaction: {
                    hover: true,
                    tooltipDelay: 200,
                    selectConnectedEdges: false
                }
            };

            try {
                network = new vis.Network(container, data, options);

                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                network.on('click', handleNodeClick);
                network.on('deselectNode', clearHighlight);

                showMessage('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æç”»å®Œäº†ï¼å€‹ä½“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¦ªå­é–¢ä¿‚ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã—ã¦ãã ã•ã„ã€‚', 'success');
            } catch (error) {
                showMessage('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æç”»ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // ãƒãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆæ©Ÿèƒ½ï¼‰
        function handleNodeClick(params) {
            clearHighlight();

            if (params.nodes.length > 0) {
                const nodeId = params.nodes[0];
                
                // çµåˆãƒãƒ¼ãƒ‰ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆ
                if (nodeId.startsWith('union_')) {
                    const coupleKey = nodeId.replace('union_', '');
                    const [parent1, parent2] = coupleKey.split('|');
                    const children = koalaData
                        .filter(k => k.father === parent1 && k.mother === parent2)
                        .map(k => k.name);
                    
                    const details = `
                        <strong>ğŸ‘« ç¹æ®–ãƒšã‚¢æƒ…å ±</strong><br>
                        çˆ¶è¦ª: ${parent1}<br>
                        æ¯è¦ª: ${parent2}<br>
                        å­ã©ã‚‚ã®æ•°: ${children.length}åŒ¹<br>
                        å­ã©ã‚‚: ${children.join(', ') || 'ãªã—'}
                    `;
                    showMessage(details, 'info');
                    return;
                }

                // é€šå¸¸ã®ã‚³ã‚¢ãƒ©ãƒãƒ¼ãƒ‰ã®å ´åˆã€è¦ªå­é–¢ä¿‚ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                const koala = koalaData.find(k => k.name === nodeId);
                if (koala) {
                    highlightParentChild(nodeId);
                    showKoalaDetails(koala);
                }
            }
        }

        // è¦ªå­é–¢ä¿‚ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        function highlightParentChild(selectedNodeId) {
            const koala = koalaData.find(k => k.name === selectedNodeId);
            if (!koala) return;

            const nodesToHighlight = [selectedNodeId];
            const edgesToHighlight = [];

            // è¦ªã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆå¯¾è±¡ã«è¿½åŠ 
            if (koala.father) {
                nodesToHighlight.push(koala.father);
                
                // è¦ªã¸ã®çµåˆãƒãƒ¼ãƒ‰ã¨ã‚¨ãƒƒã‚¸ã‚’è¦‹ã¤ã‘ã‚‹
                const unionNodeId = `union_${[koala.father, koala.mother].sort().join('|')}`;
                if (nodes.get(unionNodeId)) {
                    nodesToHighlight.push(unionNodeId);
                    nodesToHighlight.push(koala.mother);
                    
                    // è¦ªé–¢é€£ã®ã‚¨ãƒƒã‚¸ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                    edgesToHighlight.push(`marriage_${koala.father}_${unionNodeId}`);
                    edgesToHighlight.push(`marriage_${koala.mother}_${unionNodeId}`);
                    edgesToHighlight.push(`offspring_${unionNodeId}_${selectedNodeId}`);
                }
            }

            // å­ã©ã‚‚ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆå¯¾è±¡ã«è¿½åŠ 
            const children = koalaData.filter(k => k.father === selectedNodeId || k.mother === selectedNodeId);
            children.forEach(child => {
                nodesToHighlight.push(child.name);
                
                // å­ã©ã‚‚ã¸ã®çµåˆãƒãƒ¼ãƒ‰ã¨ã‚¨ãƒƒã‚¸ã‚’è¦‹ã¤ã‘ã‚‹
                const partners = koala.partners;
                partners.forEach(partner => {
                    const unionNodeId = `union_${[selectedNodeId, partner].sort().join('|')}`;
                    if (nodes.get(unionNodeId)) {
                        nodesToHighlight.push(unionNodeId);
                        nodesToHighlight.push(partner);
                        
                        edgesToHighlight.push(`marriage_${selectedNodeId}_${unionNodeId}`);
                        edgesToHighlight.push(`marriage_${partner}_${unionNodeId}`);
                        edgesToHighlight.push(`offspring_${unionNodeId}_${child.name}`);
                    }
                });
            });

            // ãƒã‚¤ãƒ©ã‚¤ãƒˆé©ç”¨
            applyHighlight(nodesToHighlight, edgesToHighlight);

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            updateHighlightStatus(selectedNodeId, nodesToHighlight.length - 1);
        }

        // ãƒã‚¤ãƒ©ã‚¤ãƒˆé©ç”¨
        function applyHighlight(nodeIds, edgeIds) {
            // å…¨ãƒãƒ¼ãƒ‰ã‚’è–„ã
            const allNodes = nodes.get();
            allNodes.forEach(node => {
                if (nodeIds.includes(node.id)) {
                    // ãƒã‚¤ãƒ©ã‚¤ãƒˆå¯¾è±¡
                    const highlightColor = node.group === 'union' ? 
                        { background: '#ffeb3b', border: '#f57c00' } :
                        { background: '#ffeb3b', border: '#ff9800' };
                    
                    nodes.update({
                        id: node.id,
                        color: highlightColor,
                        borderWidth: 6,
                        shadow: {
                            enabled: true,
                            color: 'rgba(255, 235, 59, 0.8)',
                            size: 10
                        }
                    });
                    highlightedNodes.push(node.id);
                } else {
                    // éãƒã‚¤ãƒ©ã‚¤ãƒˆå¯¾è±¡ã‚’è–„ã
                    const fadedColor = {
                        background: '#f5f5f5',
                        border: '#cccccc'
                    };
                    nodes.update({
                        id: node.id,
                        color: fadedColor,
                        borderWidth: 1
                    });
                }
            });

            // å…¨ã‚¨ãƒƒã‚¸ã‚’è–„ã
            const allEdges = edges.get();
            allEdges.forEach(edge => {
                if (edgeIds.includes(edge.id)) {
                    // ãƒã‚¤ãƒ©ã‚¤ãƒˆå¯¾è±¡
                    edges.update({
                        id: edge.id,
                        color: { color: '#ffeb3b' },
                        width: edge.width + 2,
                        shadow: {
                            enabled: true,
                            color: 'rgba(255, 235, 59, 0.8)',
                            size: 5
                        }
                    });
                    highlightedEdges.push(edge.id);
                } else {
                    // éãƒã‚¤ãƒ©ã‚¤ãƒˆå¯¾è±¡ã‚’è–„ã
                    edges.update({
                        id: edge.id,
                        color: { color: '#e0e0e0' },
                        width: Math.max(1, edge.width - 1)
                    });
                }
            });
        }

        // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚¯ãƒªã‚¢
        function clearHighlight() {
            // ãƒãƒ¼ãƒ‰ã‚’å…ƒã«æˆ»ã™
            highlightedNodes.forEach(nodeId => {
                const originalColor = originalNodeColors.get(nodeId);
                const node = nodes.get(nodeId);
                nodes.update({
                    id: nodeId,
                    color: originalColor,
                    borderWidth: node.shape === 'circularImage' ? 4 : 3,
                    shadow: {
                        enabled: true,
                        color: 'rgba(0,0,0,0.2)',
                        size: 5
                    }
                });
            });

            // ã‚¨ãƒƒã‚¸ã‚’å…ƒã«æˆ»ã™
            highlightedEdges.forEach(edgeId => {
                const originalColor = originalEdgeColors.get(edgeId);
                const originalEdge = edges.get(edgeId);
                edges.update({
                    id: edgeId,
                    color: originalColor,
                    width: originalEdge.width,
                    shadow: {
                        enabled: true,
                        color: 'rgba(0,0,0,0.1)',
                        size: 3
                    }
                });
            });

            // å…¨ãƒãƒ¼ãƒ‰ã‚’å…ƒã®è‰²ã«æˆ»ã™
            const allNodes = nodes.get();
            allNodes.forEach(node => {
                if (!highlightedNodes.includes(node.id)) {
                    const originalColor = originalNodeColors.get(node.id);
                    nodes.update({
                        id: node.id,
                        color: originalColor,
                        borderWidth: node.shape === 'circularImage' ? 4 : 3
                    });
                }
            });

            // å…¨ã‚¨ãƒƒã‚¸ã‚’å…ƒã®è‰²ã«æˆ»ã™
            const allEdges = edges.get();
            allEdges.forEach(edge => {
                if (!highlightedEdges.includes(edge.id)) {
                    const originalColor = originalEdgeColors.get(edge.id);
                    edges.update({
                        id: edge.id,
                        color: originalColor,
                        width: edge.width
                    });
                }
            });

            highlightedNodes = [];
            highlightedEdges = [];
            
            updateHighlightStatus(null, 0);
        }

        // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateHighlightStatus(selectedName, relatedCount) {
            const statusDiv = document.getElementById('highlightStatus');
            if (selectedName) {
                statusDiv.innerHTML = `ãƒã‚¤ãƒ©ã‚¤ãƒˆ: <strong>${selectedName}</strong> ã¨é–¢é€£å€‹ä½“ ${relatedCount}åŒ¹`;
                statusDiv.style.background = '#fff3e0';
                statusDiv.style.color = '#f57c00';
            } else {
                statusDiv.innerHTML = 'ãƒã‚¤ãƒ©ã‚¤ãƒˆ: ãªã—';
                statusDiv.style.background = '#e3f2fd';
                statusDiv.style.color = '#1976d2';
            }
        }

        // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³å–å¾—
        function getLayoutOptions() {
            const layoutType = document.getElementById('layoutType').value;
            
            switch (layoutType) {
                case 'hierarchical':
                    return {
                        hierarchical: {
                            direction: 'UD',
                            sortMethod: 'directed',
                            nodeSpacing: 250,
                            levelSeparation: 200,
                            treeSpacing: 300,
                            blockShifting: true,
                            edgeMinimization: true,
                            parentCentralization: true
                        }
                    };
                case 'force':
                    return {
                        improvedLayout: true,
                        randomSeed: 42
                    };
                case 'circular':
                    return {
                        randomSeed: 2
                    };
                default:
                    return {};
            }
        }

        // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ›´æ–°
        function updateLayout() {
            if (network) {
                const options = {
                    layout: getLayoutOptions(),
                    physics: {
                        enabled: document.getElementById('physics').value === 'true'
                    }
                };
                network.setOptions(options);
                network.redraw();
            }
        }

        // ãƒãƒ¼ãƒ‰ã‚µã‚¤ã‚ºæ›´æ–°
        function updateNodeSize() {
            const size = parseInt(document.getElementById('nodeSize').value);
            document.getElementById('nodeSizeValue').textContent = size;
            
            if (network && nodes) {
                const allNodes = nodes.get();
                allNodes.forEach(node => {
                    nodes.update({
                        id: node.id,
                        size: node.group === 'union' ? 20 : size
                    });
                });
            }
        }

        // ã‚¨ãƒƒã‚¸å¹…æ›´æ–°
        function updateEdgeWidth() {
            const width = parseInt(document.getElementById('edgeWidth').value);
            document.getElementById('edgeWidthValue').textContent = width;
            
            if (network && edges) {
                const allEdges = edges.get();
                allEdges.forEach(edge => {
                    const newWidth = edge.type === 'offspring' ? width - 1 : width;
                    edges.update({
                        id: edge.id,
                        width: newWidth
                    });
                });
            }
        }

        // ç‰©ç†æ¼”ç®—æ›´æ–°
        function updatePhysics() {
            if (network) {
                const enabled = document.getElementById('physics').value === 'true';
                network.setOptions({
                    physics: { enabled: enabled }
                });
            }
        }

        // è¡¨ç¤ºå€¤æ›´æ–°
        function updateDisplayValues() {
            document.getElementById('nodeSizeValue').textContent = document.getElementById('nodeSize').value;
            document.getElementById('edgeWidthValue').textContent = document.getElementById('edgeWidth').value;
        }

        // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å…¨ä½“è¡¨ç¤º
        function fitNetwork() {
            if (network) {
                network.fit({
                    animation: {
                        duration: 1000,
                        easingFunction: 'easeInOutQuad'
                    }
                });
            }
        }

        // ã‚ªã‚¹ã«æ³¨ç›®
        function focusOnMales() {
            if (network && koalaData) {
                const maleNodes = koalaData
                    .filter(k => getKoalaGroup(k) === 'male')
                    .map(k => k.name);
                
                if (maleNodes.length > 0) {
                    network.focus(maleNodes[0], {
                        scale: 1.5,
                        animation: {
                            duration: 1000,
                            easingFunction: 'easeInOutQuad'
                        }
                    });
                }
            }
        }

        // ã‚³ã‚¢ãƒ©è©³ç´°è¡¨ç¤º
        function showKoalaDetails(koala) {
            const childrenCount = koalaData.filter(k => 
                k.father === koala.name || k.mother === koala.name
            ).length;

            const children = koalaData
                .filter(k => k.father === koala.name || k.mother === koala.name)
                .map(k => k.name);

            const details = `
                <strong>ğŸ¨ ${koala.name} ã®è©³ç´°æƒ…å ±</strong><br>
                æ€§åˆ¥: ${koala.gender}<br>
                ç”Ÿå¹´æœˆæ—¥: ${koala.birthDate || 'ä¸æ˜'}<br>
                ä¸¡è¦ª: ${koala.father || 'ä¸æ˜'} Ã— ${koala.mother || 'ä¸æ˜'}<br>
                ç¹æ®–ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æ•°: ${koala.partners.length}åŒ¹<br>
                ç¹æ®–ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼: ${koala.partners.join(', ') || 'ãªã—'}<br>
                å­ã©ã‚‚ã®æ•°: ${childrenCount}åŒ¹<br>
                å­ã©ã‚‚: ${children.join(', ') || 'ãªã—'}<br>
                ã‚¢ã‚¤ã‚³ãƒ³: ${koala.icon ? 'æœ‰ã‚Š' : 'ãªã—'}
            `;
            showMessage(details, 'info');
        }

        // çµ±è¨ˆè¨ˆç®—
        function calculateKoalaStats(data) {
            const males = data.filter(k => getKoalaGroup(k) === 'male').length;
            const females = data.filter(k => getKoalaGroup(k) === 'female').length;
            const withIcons = data.filter(k => k.icon && k.icon.startsWith('http')).length;
            
            const breedingPairs = new Set();
            data.forEach(koala => {
                koala.partners.forEach(partner => {
                    const pair = [koala.name, partner].sort().join('|');
                    breedingPairs.add(pair);
                });
            });

            let generations = 1;
            data.forEach(koala => {
                if (koala.father || koala.mother) {
                    generations = Math.max(generations, 2);
                    
                    // ç¥–çˆ¶æ¯ãŒã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    const father = data.find(k => k.name === koala.father);
                    const mother = data.find(k => k.name === koala.mother);
                    if ((father && (father.father || father.mother)) || 
                        (mother && (mother.father || mother.mother))) {
                        generations = Math.max(generations, 3);
                    }
                }
            });

            return {
                total: data.length,
                males,
                females,
                breedingPairs: breedingPairs.size,
                generations,
                withIcons
            };
        }

        // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportNetwork() {
            try {
                if (!network) {
                    showMessage('å®¶ç³»å›³ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                    return;
                }

                const canvas = network.canvas.body.container.children[0];
                if (canvas && canvas.toDataURL) {
                    const dataURL = canvas.toDataURL('image/png', 1.0);
                    const link = document.createElement('a');
                    link.download = `ã‚³ã‚¢ãƒ©å®¶ç³»å›³_${new Date().getTime()}.png`;
                    link.href = dataURL;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showMessage('é«˜å“è³ªãªç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼', 'success');
                } else {
                    showMessage('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚', 'info');
                }
            } catch (error) {
                console.error('Export error:', error);
                showMessage('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ãŠè©¦ã—ãã ã•ã„ã€‚', 'info');
            }
        }

        // ã™ã¹ã¦ã‚¯ãƒªã‚¢
        function clearAll() {
            document.getElementById('csvInput').value = '';
            
            if (network) {
                network.destroy();
                network = null;
            }
            
            document.getElementById('network-container').innerHTML = '';
            document.getElementById('controlsSection').style.display = 'none';
            document.getElementById('statsInfo').style.display = 'none';
            document.getElementById('exportBtn').disabled = true;
            
            koalaData = [];
            nodes = null;
            edges = null;
            highlightedNodes = [];
            highlightedEdges = [];
            originalNodeColors.clear();
            originalEdgeColors.clear();
            
            clearMessages();
            showMessage('ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showMessage(text, type) {
            const messagesDiv = document.getElementById('messages');
            let className = 'success-message';
            
            if (type === 'error') {
                className = 'error-message';
            } else if (type === 'info') {
                className = 'stats-info';
            }
            
            messagesDiv.innerHTML = `<div class="${className}">${text}</div>`;
            
            setTimeout(() => {
                if (messagesDiv.innerHTML.includes(text)) {
                    messagesDiv.innerHTML = '';
                }
            }, 6000);
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }

        // åˆæœŸåŒ–å®Ÿè¡Œï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿å¾…ã¡ï¼‰
        window.addEventListener('load', function() {
            setTimeout(initialize, 100);
        });

        // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œãªã„å ´åˆã®ä»£æ›¿æ¡ˆ
        window.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                if (typeof vis === 'undefined') {
                    console.warn('vis.js loading failed, trying alternative CDN...');
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/vis@4.21.0/dist/vis.min.js';
                    script.onload = function() {
                        console.log('Alternative vis.js loaded successfully');
                        initialize();
                    };
                    script.onerror = function() {
                        showMessage('ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
                    };
                    document.head.appendChild(script);
                }
            }, 1000);
        });
    </script>
</body>
</html>